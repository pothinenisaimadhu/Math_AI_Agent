<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Math AI Tutor</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@11.3.28/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/lucide@0.441.0/dist/umd/lucide.min.js"></script>
    <script src="https://unpkg.com/react-katex@3.0.1/dist/react-katex.min.js"></script>
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://unpkg.com/katex@0.16.11/dist/katex.min.css" rel="stylesheet" />
  </head>
  <body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
      const { useState } = React;
      const { motion, AnimatePresence } = window.FramerMotion;
      const { Send, Loader2, Bot, User, History, Edit2, Menu } = window.lucide;
      const { InlineMath, BlockMath } = window.ReactKaTeX;

      function App() {
        const [question, setQuestion] = useState("");
        const [messages, setMessages] = useState([]);
        const [loading, setLoading] = useState(false);
        const [chatHistory, setChatHistory] = useState([]);
        const [editingId, setEditingId] = useState(null);
        const [editText, setEditText] = useState("");
        const [isSidebarOpen, setIsSidebarOpen] = useState(false);

        const handleSubmit = async (queryText = question) => {
          if (!queryText.trim()) return;

          const newMessages = [
            ...messages,
            { type: "user", text: queryText, id: Date.now() },
          ];
          setMessages(newMessages);
          setQuestion("");
          setLoading(true);

          try {
            const res = await fetch("http://localhost:8000/solve", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_id: "demo", question: queryText }),
            });

            const data = await res.json();
            const botResponse = {
              type: "bot",
              text: data.error
                ? `Error: ${data.error}`
                : data.answer || "No answer provided",
              id: Date.now() + 1,
            };

            const finalMessages = [...newMessages, botResponse];
            setMessages(finalMessages);

            setChatHistory(prev => [{
              id: Date.now(),
              question: queryText,
              answer: botResponse.text,
              timestamp: new Date().toLocaleTimeString(),
            }, ...prev]);
          } catch (error) {
            const errorMsg = { type: "bot", text: `Error: ${error.message}`, id: Date.now() + 1 };
            setMessages([...newMessages, errorMsg]);
          }

          setLoading(false);
          setIsSidebarOpen(false);
        };

        const handleEdit = (historyItem) => {
          setEditingId(historyItem.id);
          setEditText(historyItem.question);
        };

        const handleSaveEdit = () => {
          if (editText.trim()) {
            handleSubmit(editText);
            setEditingId(null);
            setEditText("");
          }
        };

        const handleHistoryClick = (historyItem) => {
          setQuestion(historyItem.question);
          setIsSidebarOpen(false);
        };

        const toggleSidebar = () => {
          setIsSidebarOpen(!isSidebarOpen);
        };

        const renderMessageText = (text) => {
          const parts = text.split(/(\$\$[\s\S]+?\$\$|\$[\s\S]+?\$)/g);
          return parts.map((part, index) => {
            if (part.startsWith("$$") && part.endsWith("$$")) {
              return <BlockMath key={index} math={part.slice(2, -2)} />;
            } else if (part.startsWith("$") && part.endsWith("$")) {
              return <InlineMath key={index} math={part.slice(1, -1)} />;
            }
            return <span key={index} className="whitespace-pre-wrap">{part}</span>;
          });
        };

        return (
          <div className="flex h-screen max-w-7xl mx-auto">
            {/* Sidebar */}
            <AnimatePresence>
              {isSidebarOpen && (
                <motion.div
                  initial={{ x: -300, opacity: 0 }}
                  animate={{ x: 0, opacity: 1 }}
                  exit={{ x: -300, opacity: 0 }}
                  transition={{ duration: 0.3 }}
                  className="fixed md:static md:flex w-80 bg-white border-r border-gray-200 flex-col shadow-lg z-20"
                >
                  <div className="p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white flex justify-between items-center">
                    <div className="flex items-center gap-2">
                      <History className="w-5 h-5" />
                      <h2 className="font-semibold text-lg">Chat History</h2>
                    </div>
                    <button onClick={toggleSidebar} className="md:hidden text-white">
                      <Menu className="w-5 h-5" />
                    </button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 space-y-3">
                    {chatHistory.length === 0 ? (
                      <p className="text-gray-400 text-sm text-center mt-8">No chat history yet</p>
                    ) : (
                      chatHistory.map((item) => (
                        <motion.div
                          key={item.id}
                          initial={{ opacity: 0 }}
                          animate={{ opacity: 1 }}
                          className="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors cursor-pointer"
                        >
                          {editingId === item.id ? (
                            <div className="space-y-2">
                              <textarea
                                value={editText}
                                onChange={(e) => setEditText(e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded-lg text-sm resize-none focus:ring-2 focus:ring-indigo-500"
                                rows={2}
                              />
                              <div className="flex gap-2">
                                <button
                                  onClick={handleSaveEdit}
                                  className="px-3 py-1 bg-indigo-500 text-white rounded-lg text-xs hover:bg-indigo-600 transition"
                                >
                                  Send
                                </button>
                                <button
                                  onClick={() => setEditingId(null)}
                                  className="px-3 py-1 bg-gray-300 text-gray-700 rounded-lg text-xs hover:bg-gray-400 transition"
                                >
                                  Cancel
                                </button>
                              </div>
                            </div>
                          ) : (
                            <div>
                              <div className="flex items-start justify-between gap-2">
                                <p
                                  className="text-sm text-gray-800 hover:text-indigo-600 flex-1"
                                  onClick={() => handleHistoryClick(item)}
                                >
                                  {item.question}
                                </p>
                                <button
                                  onClick={() => handleEdit(item)}
                                  className="p-1 text-gray-400 hover:text-indigo-500"
                                >
                                  <Edit2 className="w-4 h-4" />
                                </button>
                              </div>
                              <p className="text-xs text-gray-500 mt-1">{item.timestamp}</p>
                            </div>
                          )}
                        </motion.div>
                      ))
                    )}
                  </div>
                </motion.div>
              )}
            </AnimatePresence>

            {/* Main Chat Area */}
            <div className="flex-1 flex flex-col">
              <motion.div
                initial={{ y: -50, opacity: 0 }}
                animate={{ y: 0, opacity: 1 }}
                transition={{ duration: 0.5 }}
                className="p-6 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-center rounded-b-2xl shadow-lg flex justify-between items-center"
              >
                <div className="flex-1">
                  <h1 className="text-3xl font-extrabold tracking-tight">Math AI Tutor</h1>
                  <p className="text-indigo-100 mt-2 text-lg">Your friendly guide to mastering math!</p>
                </div>
                <button onClick={toggleSidebar} className="md:hidden text-white">
                  <Menu className="w-6 h-6" />
                </button>
              </motion.div>

              <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-white/50 backdrop-blur-sm m-4 rounded-2xl shadow-inner">
                {messages.length === 0 && !loading && (
                  <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    className="text-center text-gray-400 mt-20"
                  >
                    <Bot className="w-16 h-16 mx-auto mb-4 text-indigo-300" />
                    <p>Start by asking a math question!</p>
                  </motion.div>
                )}
                {messages.map((msg) => (
                  <motion.div
                    key={msg.id}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.3 }}
                    className={`flex items-start gap-3 ${
                      msg.type === "user" ? "justify-end" : "justify-start"
                    }`}
                  >
                    {msg.type === "bot" && (
                      <div className="p-2 bg-indigo-100 rounded-full shadow-sm">
                        <Bot className="w-5 h-5 text-indigo-600" />
                      </div>
                    )}
                    <div
                      className={`p-4 rounded-2xl max-w-lg shadow-md ${
                        msg.type === "user"
                          ? "bg-gradient-to-r from-indigo-500 to-indigo-700 text-white"
                          : "bg-white border border-gray-200 text-gray-800"
                      }`}
                    >
                      {renderMessageText(msg.text)}
                    </div>
                    {msg.type === "user" && (
                      <div className="p-2 bg-indigo-500 rounded-full shadow-sm">
                        <User className="w-5 h-5 text-white" />
                      </div>
                    )}
                  </motion.div>
                ))}
                {loading && (
                  <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    className="flex items-center gap-3 text-indigo-500"
                  >
                    <Loader2 className="w-5 h-5 animate-spin" />
                    <span>Solving...</span>
                  </motion.div>
                )}
              </div>

              <motion.div
                initial={{ y: 50, opacity: 0 }}
                animate={{ y: 0, opacity: 1 }}
                transition={{ duration: 0.5 }}
                className="p-4 bg-white rounded-t-2xl shadow-lg"
              >
                <div className="flex items-end gap-3">
                  <textarea
                    value={question}
                    onChange={(e) => setQuestion(e.target.value)}
                    placeholder="Ask your math question (e.g., Solve $x^2 + 2x - 3 = 0$)..."
                    rows={2}
                    className="flex-1 resize-none border border-gray-200 rounded-xl p-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none bg-gray-50 text-gray-800 placeholder-gray-400 transition-all duration-200"
                    onKeyPress={(e) => {
                      if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        handleSubmit();
                      }
                    }}
                  />
                  <button
                    onClick={() => handleSubmit()}
                    disabled={loading || !question.trim()}
                    className={`p-4 rounded-xl shadow-md transition-all duration-200 ${
                      loading || !question.trim()
                        ? "bg-gray-300 cursor-not-allowed"
                        : "bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:from-indigo-700 hover:to-purple-700"
                    }`}
                  >
                    {loading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5" />}
                  </button>
                </div>
              </motion.div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>